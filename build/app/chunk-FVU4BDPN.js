import{b}from"./chunk-I66BKAGK.js";import{a as U}from"./chunk-2LP224VR.js";import{c as g}from"./chunk-DSTAATMF.js";import{$ as h,F as c,Yc as m,_c as f,ea as l,n as d,q as p,u as s}from"./chunk-EYQN4OQ3.js";var a=class extends Error{};a.prototype.name="InvalidTokenError";function y(o){return decodeURIComponent(atob(o).replace(/(.)/g,(t,e)=>{let r=e.charCodeAt(0).toString(16).toUpperCase();return r.length<2&&(r="0"+r),"%"+r}))}function k(o){let t=o.replace(/-/g,"+").replace(/_/g,"/");switch(t.length%4){case 0:break;case 2:t+="==";break;case 3:t+="=";break;default:throw new Error("base64 string is not of the correct length")}try{return y(t)}catch{return atob(t)}}function u(o,t){if(typeof o!="string")throw new a("Invalid token specified: must be a string");t||(t={});let e=t.header===!0?0:1,r=o.split(".")[e];if(typeof r!="string")throw new a(`Invalid token specified: missing part #${e+1}`);let n;try{n=k(r)}catch(i){throw new a(`Invalid token specified: invalid base64 for part #${e+1} (${i.message})`)}try{return JSON.parse(n)}catch(i){throw new a(`Invalid token specified: invalid json for part #${e+1} (${i.message})`)}}var v=class o{constructor(t,e,r){this.http=t;this.toast=e;this.router=r;this.currentUserSubject=new d(this.getValidatedStoredUser()),this.currentUser=this.currentUserSubject.asObservable()}currentUserSubject;currentUser;apiURL=U.apiUrl;verifyTokenWithBackend(t){return this.http.post(this.apiURL+"/verify-token",{token:t},{headers:new m().set("Content-Type","application/json")})}isAuthenticated$(){let t=this.currentUserValue;return t?this.verifyTokenWithBackend(t?.token).pipe(s(e=>e?.valid&&this.isTokenValid(t.token||"")),c(()=>p(!1))):p(!1)}getValidatedStoredUser(){let t=localStorage.getItem("currentUser");if(!t)return null;try{let e=JSON.parse(t);return e.token&&this.isTokenValid(e.token)?e:(this.logout(),null)}catch{return localStorage.removeItem("currentUser"),null}}extractUser(){let t=localStorage.getItem("currentUser");if(!t)return null;try{let e=JSON.parse(t);return u(e?.token)}catch{return!1}}isTokenValid(t){try{let e=u(t),r=Math.floor(Date.now()/1e3),n=e.exp>r,i=!!e.email&&!!e.role;return n&&i}catch{return!1}}login(t,e){return this.http.post(this.apiURL+"/login",{email:t,password:e}).pipe(s(r=>{if(r.token&&this.isTokenValid(r.token)){let n=u(r.token),i={phone:r.phone,email:r.email,names:r.names,role:n.role,token:r.token};return localStorage.setItem("currentUser",JSON.stringify(i)),this.currentUserSubject.next(i),i}else throw new Error("Invalid token received")}),c(r=>{throw this.toast.showError("Login Failed","Invalid Credentials. "),r}))}register(t){return this.http.post(this.apiURL+"/register",t).pipe(s(e=>(console.log(e),e)),c(e=>{throw console.log("Registration failed",e),console.error("Registration failed",e),e}))}logout(){localStorage.removeItem("currentUser"),this.currentUserSubject.next(null),this.router.navigate(["../"])}getUserByEmail(t){return this.http.get(this.apiURL+"/checkAccount?email="+t).pipe(s(e=>e),c(e=>{throw console.error("Failed",e),e}))}resetPassword(t,e){let r={email:t,password:e};return this.http.post(this.apiURL+"/resetPassword",r).pipe(s(n=>n),c(n=>{throw console.error("Failed to reset password",n),n}))}get currentUserValue(){return this.currentUserSubject.value}static \u0275fac=function(e){return new(e||o)(l(f),l(b),l(g))};static \u0275prov=h({token:o,factory:o.\u0275fac,providedIn:"root"})};export{v as a};
